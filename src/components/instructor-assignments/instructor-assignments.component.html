<div class="p-6 space-y-6">
  <header class="flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold text-white">Assignments</h2>
      <p class="text-slate-400 mt-1">Manage assignments and track student submissions.</p>
    </div>
    <button (click)="openModal()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
      </svg>
      Create New Assignment
    </button>
  </header>

  <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-lg">
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="border-b border-slate-600">
                <tr>
                    <th class="p-4 text-sm font-semibold text-slate-400">Title</th>
                    <th class="p-4 text-sm font-semibold text-slate-400">Module</th>
                    <th class="p-4 text-sm font-semibold text-slate-400">Due Date</th>
                    <th class="p-4 text-sm font-semibold text-slate-400">Actions</th>
                </tr>
            </thead>
            <tbody>
                @for (assignment of assignments(); track assignment.id) {
                    <tr class="border-b border-slate-700 last:border-0 hover:bg-slate-700/50">
                        <td class="p-4 text-white font-medium">
                           <div class="flex items-center gap-2">
                             <span>{{ assignment.title }}</span>
                             @if (assignment.fileNames && assignment.fileNames.length > 0) {
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" title="Attachment included" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a3 3 0 10-6 0v4a1 1 0 102 0V7a1 1 0 112 0v4a3 3 0 11-6 0V7a5 5 0 0110 0v4a5 5 0 01-10 0V7a3 3 0 00-3-3z" clip-rule="evenodd" /></svg>
                             }
                           </div>
                        </td>
                        <td class="p-4 text-slate-300">{{ assignment.module }}</td>
                        <td class="p-4 text-slate-300">{{ assignment.dueDate }}</td>
                        <td class="p-4">
                          <div class="flex items-center gap-1">
                              <button (click)="openSubmissionsModal(assignment)" class="p-2 text-slate-400 hover:text-emerald-400 rounded-full hover:bg-slate-700" title="View Submissions">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                              </button>
                              <button (click)="openAssignModal(assignment)" class="p-2 text-slate-400 hover:text-cyan-400 rounded-full hover:bg-slate-700" title="Assign to Students">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 11a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1v-1z" /></svg>
                              </button>
                              <button (click)="openModal(assignment)" class="p-2 text-slate-400 hover:text-sky-400 rounded-full hover:bg-slate-700" title="Edit">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                              </button>
                              <button (click)="deleteAssignment(assignment)" class="p-2 text-slate-400 hover:text-red-400 rounded-full hover:bg-slate-700" title="Delete">
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                              </button>
                          </div>
                        </td>
                    </tr>
                }
                 @if (assignments().length === 0) {
                  <tr>
                    <td colspan="4" class="p-6 text-center text-slate-500">
                      You have not created any assignments yet.
                    </td>
                  </tr>
                }
            </tbody>
        </table>
    </div>
  </div>

  <!-- Pending Submissions -->
  <div class="bg-slate-800/50 backdrop-blur-lg border border-slate-700 rounded-lg p-6">
    <h3 class="text-lg font-semibold text-white mb-4">Pending Submissions for Grading</h3>
    <div class="space-y-3">
      @for (submission of pendingSubmissions(); track submission.studentName + submission.assignmentTitle) {
        <button (click)="openGradingModal(submission)" class="w-full text-left flex items-center gap-4 p-3 bg-slate-900/50 rounded-md border border-slate-700 hover:bg-slate-700/50 hover:border-emerald-500/50">
          <img [src]="submission.studentAvatarUrl" [alt]="submission.studentName" class="h-10 w-10 rounded-full flex-shrink-0">
          <div class="flex-grow grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
              <div>
                  <p class="font-medium text-white">{{ submission.studentName }}</p>
                  <p class="text-sm text-slate-400 truncate" [title]="submission.assignmentTitle">{{ submission.assignmentTitle }}</p>
              </div>
              <div>
                   <p class="font-medium text-white text-sm">{{ submission.submissionTimestamp | date:'medium' }}</p>
              </div>
              <div class="flex justify-start md:justify-end">
                  <span class="px-2 py-1 text-xs font-medium rounded-full"
                      [class.bg-emerald-900/50]="submission.onTimeStatus === 'On Time'"
                      [class.text-emerald-300]="submission.onTimeStatus === 'On Time'"
                      [class.bg-yellow-900/50]="submission.onTimeStatus === 'Late'"
                      [class.text-yellow-300]="submission.onTimeStatus === 'Late'">
                      {{ submission.onTimeStatus }}
                  </span>
              </div>
          </div>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
        </button>
      }
      @if (pendingSubmissions().length === 0) {
        <p class="text-center text-slate-500 py-4">No submissions are currently pending review.</p>
      }
    </div>
  </div>
</div>

@if (isModalOpen()) {
  <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" (click)="requestCloseModal()">
    <div class="w-full max-w-lg bg-slate-800 border border-slate-700 rounded-2xl shadow-lg flex flex-col animate-scale-in" (click)="$event.stopPropagation()">
      <form [formGroup]="assignmentForm" (ngSubmit)="saveAssignment()">
        <header class="flex items-center justify-between p-4 border-b border-slate-700">
          <h2 class="text-xl font-bold text-white">{{ editingAssignment() ? 'Edit' : 'Create' }} Assignment</h2>
          <button type="button" (click)="requestCloseModal()" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </header>
        <div class="p-6 space-y-4">
          <div>
            <label for="title" class="block text-sm font-medium text-slate-300 mb-1">Assignment Title</label>
            <input type="text" id="title" formControlName="title" class="w-full bg-slate-900/50 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:ring-emerald-500 focus:border-emerald-500">
          </div>
          <div>
            <label for="module" class="block text-sm font-medium text-slate-300 mb-1">Module</label>
            <select id="module" formControlName="module" class="w-full bg-slate-900/50 border border-slate-600 rounded-md px-3 py-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
              <option value="" disabled>Select a module</option>
              @for(module of availableModules(); track module.title) {
                <option [value]="module.title">{{ module.title }}</option>
              }
            </select>
          </div>
          <div>
            <label for="dueDate" class="block text-sm font-medium text-slate-300 mb-1">Due Date</label>
            <input type="date" id="dueDate" formControlName="dueDate" class="w-full bg-slate-900/50 border border-slate-600 rounded-md px-3 py-2 text-white placeholder-slate-400 focus:ring-emerald-500 focus:border-emerald-500">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-300 mb-2">
                Assignment Files <span class="text-red-400">*</span>
            </label>
            <div class="space-y-3">
                @for (fileName of assignmentFileNames(); track fileName; let i = $index) {
                    <div class="flex items-center justify-between p-2 pl-3 bg-slate-900/50 rounded-md border border-slate-600">
                        <div class="flex items-center gap-2 truncate">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-emerald-400 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                            <span class="text-white truncate" [title]="fileName">{{ fileName }}</span>
                        </div>
                        <button type="button" (click)="removeFile(i)" class="text-red-400 hover:text-red-300 p-1 rounded-full hover:bg-slate-700 flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                }
                <label class="cursor-pointer bg-slate-700/50 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg flex items-center gap-2 justify-center w-full border-2 border-dashed border-slate-600 hover:border-sky-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>
                    {{ assignmentFileNames().length > 0 ? 'Add More Files' : 'Choose Files' }}
                    <input type="file" (change)="onFileSelected($event)" class="hidden" multiple>
                </label>
                 @if (assignmentForm.controls.files.invalid && (assignmentForm.controls.files.touched || assignmentForm.controls.files.dirty)) {
                    <p class="text-sm text-red-400">At least one attachment is required.</p>
                }
            </div>
          </div>
        </div>
        <footer class="flex items-center justify-end p-4 border-t border-slate-700 space-x-3">
          <button type="button" (click)="requestCloseModal()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
          <button type="submit" [disabled]="assignmentForm.invalid" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg disabled:bg-slate-700 disabled:text-slate-400 disabled:cursor-not-allowed">Save Assignment</button>
        </footer>
      </form>
    </div>
  </div>
}

@if (viewingSubmissionsFor(); as assignment) {
  <app-instructor-assignment-submissions 
    [assignment]="assignment"
    (close)="closeSubmissionsModal()">
  </app-instructor-assignment-submissions>
}

@if (isAssignModalOpen() && assignmentToAssign(); as assignment) {
  <div class="fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4" (click)="closeAssignModal()">
    <div class="w-full max-w-lg bg-slate-800 border border-slate-700 rounded-2xl shadow-lg flex flex-col animate-scale-in" (click)="$event.stopPropagation()">
      <header class="flex items-center justify-between p-4 border-b border-slate-700">
        <div>
            <h2 class="text-xl font-bold text-white">Assign: {{ assignment.title }}</h2>
            <p class="text-sm text-slate-400">Select students to assign this to.</p>
        </div>
        <button type="button" (click)="closeAssignModal()" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </header>
      <div class="p-4 space-y-4">
        <!-- Search -->
        <div class="relative">
            <input 
              type="text" 
              placeholder="Search enrolled students..."
              class="w-full bg-slate-900/50 border border-slate-600 rounded-md pl-10 pr-4 py-2 text-white placeholder-slate-400 focus:ring-emerald-500 focus:border-emerald-500"
              [ngModel]="assignStudentSearchTerm()"
              (ngModelChange)="assignStudentSearchTerm.set($event)">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
            </div>
        </div>

        <!-- Student List -->
        <div class="max-h-[40vh] overflow-y-auto space-y-2 pr-2">
            @for (student of filteredEnrolledStudents(); track student.email) {
                @let isAssigned = isStudentAlreadyAssigned(student.email);
                <label 
                    class="flex items-center gap-3 p-3 rounded-md border"
                    [class.cursor-pointer]="!isAssigned"
                    [class.cursor-not-allowed]="isAssigned"
                    [class.opacity-60]="isAssigned"
                    [class.hover:bg-slate-700/50]="!isAssigned"
                    [class.border-transparent]="!isStudentSelected(student.email)"
                    [class.bg-sky-900/50]="isStudentSelected(student.email)"
                    [class.border-sky-500]="isStudentSelected(student.email)">

                    <input 
                        type="checkbox"
                        class="form-checkbox h-5 w-5 rounded text-sky-600 bg-slate-700 border-slate-500 focus:ring-sky-500 disabled:opacity-50"
                        [checked]="isStudentSelected(student.email)"
                        [disabled]="isAssigned"
                        (change)="handleStudentSelection($event, student.email)">
                    
                    <img [src]="student.avatarUrl" [alt]="student.name" class="h-10 w-10 rounded-full">
                    <div class="flex-grow">
                        <p class="font-semibold text-white">{{ student.name }}</p>
                        <p class="text-xs text-slate-400">{{ student.email }}</p>
                    </div>
                    @if (isAssigned) {
                        <span class="text-xs font-semibold text-emerald-400">Already Assigned</span>
                    }
                </label>
            }
            @if (filteredEnrolledStudents().length === 0) {
                 <p class="text-sm text-slate-500 text-center py-4">No students found.</p>
            }
        </div>
      </div>
      <footer class="flex items-center justify-end p-4 border-t border-slate-700 space-x-3">
        <button type="button" (click)="closeAssignModal()" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
        <button type="button" (click)="confirmAssignment()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-lg">Assign Selected</button>
      </footer>
    </div>
  </div>
}

@if (selectedSubmissionForGrading(); as submission) {
  <app-instructor-grading-modal 
    [submission]="submission"
    (close)="closeGradingModal()"
    (saveGrade)="handleSaveGrade($event)">
  </app-instructor-grading-modal>
}

@if(isConfirmOpen()) {
  <app-confirmation-modal
    [title]="confirmTitle()"
    [message]="confirmMessage()"
    [confirmText]="confirmActionText()"
    (confirm)="handleConfirm()"
    (cancel)="closeConfirm()">
  </app-confirmation-modal>
}